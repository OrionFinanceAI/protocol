name: "CI"

on:
  pull_request:
    branches: [main, fhevm]
  push:
    branches: [main, fhevm]

jobs:
  ci:
    name: "Build, Lint and Test"
    runs-on: ubuntu-latest

    steps:
      - name: "Check out the repo"
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: "Install Pnpm"
        uses: pnpm/action-setup@v4
        with:
          version: "8"

      - name: "Setup Node.js"
        uses: actions/setup-node@v6
        with:
          cache: pnpm
          node-version: lts/*

      - name: "Install dependencies"
        run: pnpm install

      - name: "Audit dependencies"
        run: pnpm audit --prod --audit-level high

      - name: "Build and typechain"
        run: pnpm typechain
        env:
          RPC_URL: ${{ secrets.RPC_URL }}
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          LP_PRIVATE_KEY: ${{ secrets.LP_PRIVATE_KEY }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}

      - name: "Lint"
        run: pnpm lint

      - name: "Add lint summary"
        run: |
          echo "## Lint results" >> $GITHUB_STEP_SUMMARY
          echo "✅ Passed" >> $GITHUB_STEP_SUMMARY

      - name: "Run unit tests"
        run: pnpm test
        env:
          RPC_URL: ${{ secrets.RPC_URL }}
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          LP_PRIVATE_KEY: ${{ secrets.LP_PRIVATE_KEY }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}

      - name: "Run mainnet fork tests"
        run:
          pnpm test test/crossAsset/ChainlinkPriceAdapter.test.ts test/crossAsset/ERC4626PriceAdapter.test.ts
          test/crossAsset/ERC4626ExecutionAdapter.test.ts
        env:
          RPC_URL: ${{ secrets.RPC_URL }}
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          LP_PRIVATE_KEY: ${{ secrets.LP_PRIVATE_KEY }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          FORK_MAINNET: "true"
          MAINNET_RPC_URL: ${{ secrets.MAINNET_RPC_URL }}

      - name: "Generate coverage report"
        run: pnpm coverage
        env:
          RPC_URL: ${{ secrets.RPC_URL }}
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          LP_PRIVATE_KEY: ${{ secrets.LP_PRIVATE_KEY }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          FORK_MAINNET: "true"
          MAINNET_RPC_URL: ${{ secrets.MAINNET_RPC_URL }}

      - name: "Upload coverage to Codecov"
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          fail_ci_if_error: false

      - name: "Add test summary"
        run: |
          echo "## Test results" >> $GITHUB_STEP_SUMMARY
          echo "✅ Passed" >> $GITHUB_STEP_SUMMARY

  slither:
    name: "Slither Static Analysis"
    runs-on: "ubuntu-latest"

    steps:
      - name: "Check out the repo"
        uses: "actions/checkout@v6"
        with:
          submodules: recursive

      - name: "Install Pnpm"
        uses: pnpm/action-setup@v4
        with:
          version: "8"

      - name: "Setup Node.js"
        uses: actions/setup-node@v6
        with:
          cache: pnpm
          node-version: lts/*

      - name: "Install dependencies"
        run: pnpm install

      - name: "Install Slither"
        run: |
          pip3 install slither-analyzer==0.11.3

      - name: "Run Slither with custom config"
        run: |
          pnpm slither
        env:
          RPC_URL: ${{ secrets.RPC_URL }}
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          LP_PRIVATE_KEY: ${{ secrets.LP_PRIVATE_KEY }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}

  publish-abis:
    name: "Publish Contract ABIs"
    runs-on: ubuntu-latest

    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [ci, slither]
    permissions:
      contents: write

    steps:
      - name: "Check out the repo"
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: "Install Pnpm"
        uses: pnpm/action-setup@v4
        with:
          version: "8"

      - name: "Setup Node.js"
        uses: actions/setup-node@v6
        with:
          cache: pnpm
          node-version: lts/*

      - name: "Install dependencies"
        run: pnpm install

      - name: "Compile contracts"
        run: pnpm compile
        env:
          RPC_URL: ${{ secrets.RPC_URL }}
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          LP_PRIVATE_KEY: ${{ secrets.LP_PRIVATE_KEY }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}

      - name: "Extract and package ABIs + Bytecode"
        run: |
          set -e

          mkdir -p abis

          find artifacts/contracts -name "*.json" \
            ! -name "*.dbg.json" \
            ! -path "*/mocks/*" \
            ! -path "*/test/*" \
            -exec sh -c '
              for file do
                contract_name=$(basename "$file" .json)
                jq "{abi: .abi, bytecode: .bytecode, deployedBytecode: .deployedBytecode}" "$file" > "abis/${contract_name}.json"
              done
            ' sh {} +


          ls abis/*.json | xargs -I {} basename {} .json | jq -R -s 'split("\n") | map(select(length > 0))' > abis/index.json

          tar -czvf contract-abis.tar.gz abis/

          zip -r contract-abis.zip abis/

      - name: "Get package version"
        id: package_version
        run: echo "version=$(jq -r '.version' package.json)" >> $GITHUB_OUTPUT

      - name: "Create or update ABI release"
        uses: softprops/action-gh-release@v2
        with:
          tag_name: abis-v${{ steps.package_version.outputs.version }}
          name: Contract ABIs v${{ steps.package_version.outputs.version }}
          body: |
            ## Contract ABIs

            Auto-generated ABI artifacts from commit ${{ github.sha }}.

            ### Download Options

            **All ABIs (archive):**
            ```bash
            # tar.gz
            curl -L -o contract-abis.tar.gz \
              "https://github.com/${{ github.repository }}/releases/download/abis-v${{ steps.package_version.outputs.version }}/contract-abis.tar.gz"
            tar -xzf contract-abis.tar.gz

            # zip
            curl -L -o contract-abis.zip \
              "https://github.com/${{ github.repository }}/releases/download/abis-v${{ steps.package_version.outputs.version }}/contract-abis.zip"
            ```

            **Individual ABIs:**
            ```bash
            # Example: Download OrionTransparentVault ABI
            curl -L -o OrionTransparentVault.json \
              "https://github.com/${{ github.repository }}/releases/download/abis-v${{ steps.package_version.outputs.version }}/OrionTransparentVault.json"
            ```

            **Python:**
            ```python
            import requests
            import json

            url = "https://github.com/${{ github.repository }}/releases/download/abis-v${{ steps.package_version.outputs.version }}/OrionTransparentVault.json"
            abi = requests.get(url).json()
            ```

            **TypeScript/JavaScript:**
            ```typescript
            const response = await fetch(
              "https://github.com/${{ github.repository }}/releases/download/abis-v${{ steps.package_version.outputs.version }}/OrionTransparentVault.json"
            );
            const abi = await response.json();
            ```

            ### Available Contracts

            See `index.json` for a list of all available contract ABIs.
          files: |
            contract-abis.tar.gz
            contract-abis.zip
            abis/*.json
          fail_on_unmatched_files: true
          make_latest: true
